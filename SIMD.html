<!DOCTYPE html>
<html>

<head> 
    <meta charset="utf-8"> 
    <title>Image Classification</title> 
    <link href="js_example_style.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        .inputoutput{
            float: left
            margin: 10px
        }
    </style>
</head>

<body>

    <h2>Image Classification</h2>
    <p id="status">Opencv.js is loading...</p>

    <div>
        <p>Model</p>
        <select id='modelName'>
            <option>squeezenet</option>
            <option>mobilenetv2</option>
            <option>resnet50v1</option>
            <option>resnet50v2</option>
        </select>
    </div>

    <div>
        <p>Iterations</p>
        <input type='number' id='iterations' min='1' size='4' value='200'>
    </div>

    <div>
        <p>Backend</p>
        <select id='backend'>
            <option>SIMD</option>
        </select>
    </div>

    <div class="inputoutput">
        <img id="imgsrc" width="224" height="224" alt="No image" src='./image/panda.jpg' />
        <div class="caption">test image <input type="file" id="fileinput" name="file" /> </div>
    </div>

    <button type="button" id="runButton">run</button>

    <P style="visibility: hidden" id="result"></P>


    <script type="text/javascript">
    let runButton = document.getElementById("runButton")
    let backendBox = document.getElementById("backend")
    runButton.addEventListener("click", run)
    backendBox.addEventListener("change", getBackend)
    getBackend();

    let imgelement = document.getElementById("imgsrc");
    let inputelement = document.getElementById("fileinput");
    inputelement.addEventListener("change", (e) =>{
        imgelement.src = URL.createObjectURL(e.target.files[0]);
    }, false)

    function run(){
        
        let iterations = Number(document.querySelector('#iterations').value);

        let net;
        let keywords;

        let mat = cv.imread("imgsrc");
        let matC3 = new cv.Mat(mat.matSize[0],mat.matSize[1],cv.CV_8UC3);
        cv.cvtColor(mat, matC3, cv.COLOR_RGBA2RGB);

        let matdata = matC3.data
        let stddata = []

        for(var i=0; i<mat.matSize[0]*mat.matSize[1]; ++i){
            stddata.push( (matdata[3*i]/255-0.485)/0.229 ); 
            stddata.push( (matdata[3*i+1]/255-0.456)/0.224 ); 
            stddata.push( (matdata[3*i+2]/255-0.406)/0.225 );
        }

        // let normdata = []
        // for(var k=0; k<mat.matSize[0]*mat.matSize[1]; ++k){
        //     for(var j=0; j<3; ++j){
        //         normdata.push(stddata[j*mat.matSize[0]*mat.matSize[1]+k])
        //     }
        // }

        let newMat = cv.matFromArray(mat.matSize[0],mat.matSize[1],cv.CV_32FC3,stddata)

        // cv.cvtColor(newMat, newMat, cv.COLOR_BGR2RGB)

        console.log('load model...')
        let onnxmodel = document.getElementById("modelName").value + '.onnx';
            createFileFromUrl(onnxmodel, onnxmodel, () =>{
                let url = 'labels1000.txt';
                let request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.onload = function(ev) {
                    if (request.readyState ===4 ) {
                        if(request.status === 200) {
                        keywords = request.response;
                        keywords = keywords.split('\n')
                            net = cv.readNetFromONNX(onnxmodel);
                            console.log('start inference...')
                            let input = cv.blobFromImage(newMat, 1, new cv.Size(224, 224), new cv.Scalar(0,0,0));
                            net.setInput(input);
                            
                            let timeSum = [];
                            let topNum = 5;
                            for(let i = 0; i<iterations+1; ++i){
                                let start = Date.now();
                                var result = net.forward();
                                let end = Date.now();

                                let classes = getTopClasses(result, keywords, topNum);
                                let delta = end - start;
                                console.log(`Iterations: ${i+1} / ${iterations+1}, inference time: ${delta}ms`);
                                printResult(classes, topNum);
                                timeSum.push(delta);                                
                            };
                            let finalResult = summarize(timeSum);
                            console.log('Test finished!');
                            document.getElementById("result").style.visibility="visible";
                            document.getElementById("result").innerHTML=`Backend: ${document.getElementById("backend").value} <br>
                                                                         Model: ${document.getElementById("modelName").value} <br>
                                                                         Inference Time: ${finalResult.mean.toFixed(2)} Â± ${finalResult.std.toFixed(2)} [ms]`;
                        };
                    };
                };
                request.send();
            });
    };

    function getBackend(){
        let backend = document.getElementById("backend").value;

        var head = document.getElementsByTagName('head')[0];
        if(document.getElementById("backendScript")!=null){
            console.log('delete backend')
            delete window.cv;
        };

        var js = document.createElement("script");
        js.type = "text/javascript";
        js.id = 'backendScript';
        switch (backend){
            case 'WASM':
                js.src = "./backend/WASM/opencv.js";
                break;
            case 'Threads':
                js.src = "./backend/Threads/opencv.js";
                break;
            case 'SIMD':
                js.src = "./backend/SIMD/opencv.js";
                break;
            case 'Threads+SIMD':
                js.src = "./backend/Threads+SIMD/opencv.js";
                break;
            default: throw new Error('Undefined backend')
        }
        head.appendChild(js);
        console.log("opencv.js loaded");
        opencvready();
    };

    function createFileFromUrl(path, url, callback){
        let request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function(ev) {
            if (request.readyState === 4) {
                if (request.status === 200) {
                    let data = new Uint8Array(request.response);
                    cv.FS_createDataFile('/', path, data, true, false, false);
                    callback();
                } else {
                    console.log('Failed to load ' + url + ' status: ' + request.status);
                }
            }
        };
        request.send();
    };

    function softmax(arr) {
        const C = Math.max(...arr);
        const d = arr.map((y) => Math.exp(y - C)).reduce((a, b) => a + b);
        return arr.map((value, index) => { 
            return Math.exp(value - C) / d;
        })
    }


    function getTopClasses(mat, labels, k = 5) {
        let initdata = mat.data32F;
        initdata = softmax(initdata);
        let probs = Array.from(initdata);
        let indexes = probs.map((prob, index) => [prob, index]);
        let sorted = indexes.sort((a, b) => {
        if (a[0] === b[0]) {return 0;}
        return a[0] < b[0] ? -1 : 1;
        });
        sorted.reverse();
        let classes = [];
        for (let i = 0; i < k; ++i) {
        let prob = sorted[i][0];
        let index = sorted[i][1];
        let c = {
            label: labels[index],
            prob: (prob * 100).toFixed(2)
        }
        classes.push(c);
        }
        return classes;
    }

    function printResult(classes, topNum){
        for (let i = 0; i < topNum; ++i){
            console.log(`label: ${classes[i].label}, probability: ${classes[i].prob}%`)
        }
    }

    function summarize(results) {
        if (results.length !== 0) {
            // remove first run, which is regarded as "warming up" execution
            results.shift();
            let d = results.reduce((d, v) => {
                d.sum += v;
                d.sum2 += v * v;
                return d;
            }, {
                sum: 0,
                sum2: 0
            });
            let mean = d.sum / results.length;
            let std = Math.sqrt((d.sum2 - results.length * mean * mean) / (results.length - 1));
            return {
                mean: mean,
                std: std
            };
        } else {
            return null;
        }
    }

    function opencvready(){
            document.getElementById("status").innerHTML = "opencv.js is ready."
    }

    </script>

</body>

</html>
